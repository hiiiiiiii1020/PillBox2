<!-- ä¿ç•™åŸ HTML å¼€å¤´å’Œæ ·å¼ä¸å˜ï¼ˆç•¥ï¼‰ -->
<!-- ...ä½ çš„ <head> å’Œ <body> éƒ¨åˆ†ä¿æŒåŸæ ·ï¼Œè¿™é‡Œç›´æ¥è·³åˆ° JavaScript éƒ¨åˆ†ä¿®å¤ sendReminders å‡½æ•° -->

<script>
    // ä½¿ç”¨çœŸå® HTTP è¯·æ±‚
    async function sendHttpRequest(url) {
        try {
            const response = await fetch(url, {
                method: 'GET',
                mode: 'no-cors' // âš ï¸ å¦‚æœ ESP32 ä¸æ”¯æŒ CORSï¼Œå¯ä»¥è®¾ä¸º no-cors
            });

            // è‹¥ä½¿ç”¨ no-corsï¼Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥æµè§ˆå™¨éƒ½ä¸ä¼šè¿”å›çŠ¶æ€ï¼Œä½†æˆ‘ä»¬ä»è§†ä¸ºæˆåŠŸ
            return { status: 'sent' };
        } catch (error) {
            throw new Error(`è¿æ¥å¤±è´¥ï¼š${error.message}`);
        }
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(type, message) {
        const statusContainer = document.getElementById('statusContainer');
        const statusLabel = document.getElementById('labelStatus');

        statusContainer.classList.remove('success', 'error', 'warning');
        statusContainer.classList.add(type);

        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸'
        };

        statusLabel.textContent = `${icons[type]} ${message}`;

        statusContainer.style.transform = 'scale(0.95)';
        setTimeout(() => {
            statusContainer.style.transform = 'scale(1)';
        }, 100);
    }

    // æ›¿æ¢æ‰åŸæ¥çš„ sendReminders å‡½æ•°
    async function sendReminders() {
        const button = document.querySelector('.send-button');
        const statusLabel = document.getElementById('labelStatus');
        const espIP = document.getElementById('textboxESPIP').value.trim();

        if (!espIP) {
            updateStatus('error', 'è¯·è¾“å…¥ESP32 IPåœ°å€ï¼');
            return;
        }

        const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
        if (!ipRegex.test(espIP)) {
            updateStatus('error', 'IPåœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼');
            return;
        }

        button.disabled = true;
        button.innerHTML = '<span class="loading"></span>æ­£åœ¨å‘é€...';

        let successCount = 0;
        let totalCount = 0;

        for (let i = 1; i <= 3; i++) {
            const pillName = document.getElementById(`textbox${i}`).value.trim();
            const reminderTime = document.getElementById(`timepicker${i}`).value;

            if (pillName && reminderTime) {
                totalCount++;
                const url = `http://${espIP}/set?time=${reminderTime}&pill=${encodeURIComponent(pillName)}`;
                
                try {
                    updateStatus('warning', `æ­£åœ¨å‘é€è¯ç‰© ${i}: ${pillName} (${reminderTime})`);
                    await sendHttpRequest(url);
                    successCount++;
                    updateStatus('success', `è¯ç‰© ${i} è®¾ç½®æˆåŠŸ: ${pillName} - ${reminderTime}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    updateStatus('error', `è¯ç‰© ${i} è®¾ç½®å¤±è´¥: ${error.message}`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
        }

        button.disabled = false;
        button.innerHTML = 'ğŸ“¤ å‘é€æ‰€æœ‰æé†’è®¾ç½®';

        if (totalCount === 0) {
            updateStatus('warning', 'æ²¡æœ‰è¯ç‰©éœ€è¦è®¾ç½®æé†’');
        } else if (successCount === totalCount) {
            updateStatus('success', `âœ… æ‰€æœ‰æé†’è®¾ç½®å®Œæˆï¼å…±è®¾ç½® ${totalCount} ä¸ªè¯ç‰©æé†’`);
        } else {
            updateStatus('error', `âš ï¸ éƒ¨åˆ†è®¾ç½®å¤±è´¥ï¼æˆåŠŸï¼š${successCount}/${totalCount}`);
        }
    }

    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.text-input, .time-input');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                if (this.value.trim()) {
                    this.style.borderColor = '#48bb78';
                } else {
                    this.style.borderColor = '#e2e8f0';
                }
            });
        });
    });
</script>
